// Generated by LiveScript 1.6.0
(function(){
  var localStorage, jsonParse, api, moment, plus, ref$, foldl, map, set, getAll, getOne, removeTx, getPendingAmount, getPendingTxs, getName, createPendingTx, out$ = typeof exports != 'undefined' && exports || this, toString$ = {}.toString;
  localStorage = require('localStorage');
  jsonParse = require('./json-parse.ls');
  api = require('./api.ls');
  moment = require('moment');
  plus = require('./math.ls').plus;
  ref$ = require('prelude-ls'), foldl = ref$.foldl, map = ref$.map;
  set = function(config, arr, cb){
    var name, value;
    name = getName(config);
    value = JSON.stringify(arr);
    localStorage.setItem(name, value);
    return cb(null);
  };
  getAll = function(config, cb){
    var name, data, ref$;
    name = getName(config);
    data = (ref$ = localStorage.getItem(name)) != null ? ref$ : "";
    if (data === "") {
      return cb(null, []);
    }
    return jsonParse(data, function(err, arr){
      if (err != null) {
        return cb(err);
      }
      return cb(null, arr);
    });
  };
  getOne = function(config, cb){
    if (config.tx == null) {
      return cb("tx is required to get one");
    }
    return getAll(config, function(err, arr){
      var index;
      if (err != null) {
        return cb(err);
      }
      index = arr.map(function(it){
        return it[0];
      }).indexOf(config.tx);
      if (index === -1) {
        return cb("not found");
      }
      return cb(null, arr[index]);
    });
  };
  out$.removeTx = removeTx = function(config, cb){
    if (config.network == null) {
      return cb("network is required to remove tx");
    }
    if (config.store == null) {
      return cb("store is required to remove tx");
    }
    if (config.token == null) {
      return cb("token is required to remove tx");
    }
    if (config.tx == null) {
      return cb("tx is required to remove tx");
    }
    return getAll(config, function(err, arr){
      var index;
      if (err != null) {
        return cb(err);
      }
      if (arr.length === 0) {
        return cb("empty array");
      }
      index = arr.map(function(it){
        return it[0];
      }).indexOf(config.tx);
      if (index === -1) {
        return cb("not found");
      }
      arr.splice(index, 1);
      return set(config, arr, function(err){
        if (err != null) {
          return cb(err);
        }
        return cb(null, 'done');
      });
    });
  };
  out$.getPendingAmount = getPendingAmount = function(config, cb){
    if (config.network == null) {
      return cb("network is required");
    }
    if (config.store == null) {
      return cb("store is required");
    }
    if (config.token == null) {
      return cb("token is required");
    }
    return getAll(config, function(err, arr){
      var total;
      if (err != null) {
        return cb(err);
      }
      total = foldl(plus, 0)(
      map(function(it){
        return it[1];
      })(
      arr));
      return cb(null, total);
    });
  };
  out$.getPendingTxs = getPendingTxs = function(config, cb){
    return getAll(config, function(err, arr){
      return cb(null, arr);
    });
  };
  getName = function(arg$){
    var network, store, token, mode, index;
    network = arg$.network, store = arg$.store, token = arg$.token;
    mode = store.current.network;
    index = store.current.accountIndex;
    return "ptx-" + mode + "-" + token + "-" + index;
  };
  out$.createPendingTx = createPendingTx = function(config, cb){
    var store, network, token, tx, amountSend, amountSendFee, from, to, recipient;
    store = config.store, network = config.network, token = config.token, tx = config.tx, amountSend = config.amountSend, amountSendFee = config.amountSendFee, from = config.from, to = config.to, recipient = config.recipient;
    if (toString$.call(token).slice(8, -1) !== 'String') {
      return cb("token is required");
    }
    if (toString$.call(store).slice(8, -1) !== 'Object') {
      return cb("store is required");
    }
    if (toString$.call(network).slice(8, -1) !== 'Object') {
      return cb("network is required");
    }
    if (toString$.call(tx).slice(8, -1) !== 'String') {
      return cb("tx is required");
    }
    if (toString$.call(cb).slice(8, -1) !== 'Function') {
      return cb("callback is required");
    }
    return getAll(config, function(err, arr){
      var now, to2;
      if (err != null) {
        return cb(err);
      }
      now = moment().unix();
      to2 = recipient != null ? recipient : to;
      arr.push([tx, amountSend, amountSendFee, now, from, to2, network.token]);
      return set(config, arr, function(err){
        if (err != null) {
          return cb(err);
        }
        return cb(null);
      });
    });
  };
}).call(this);
